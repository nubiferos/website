name: Deploy Hugo site to GitHub Pages

on:
  push:
    branches: ["main"]
  schedule:
    - cron: '*/30 * * * *'
  repository_dispatch:
    types: [new-release]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.128.0'
          extended: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Fetch releases from nubiferos/nubiferos
        run: |
          mkdir -p data
          curl -s "https://api.github.com/repos/nubiferos/nubiferos/releases?per_page=5" \
            -H "Accept: application/vnd.github.v3+json" \
            > data/releases.json
          echo "Fetched releases:"
          cat data/releases.json | jq '.[].tag_name' || echo "No releases yet"

      - name: Fetch NubiferAI docs from nubiferos/nubiferai
        run: |
          DOCS_DIR="content/en/docs/nubiferai"
          mkdir -p "$DOCS_DIR"
          BASE_URL="https://raw.githubusercontent.com/nubiferos/nubiferai/trunk/docs/user-guide"

          add_frontmatter() {
            local file="$1" title="$2" link="$3" weight="$4" desc="$5" content="$6"
            printf -- '---\ntitle: "%s"\nlinkTitle: "%s"\nweight: %s\ndescription: "%s"\n---\n' \
              "$title" "$link" "$weight" "$desc" > "$DOCS_DIR/$file"
            cat "$content" >> "$DOCS_DIR/$file"
          }

          # Section index
          curl -sf "$BASE_URL/index.md" -o /tmp/nai-index.md
          add_frontmatter "_index.md" "NubiferAI" "NubiferAI" 25 \
            "AI-native cloud operations platform for NubiferOS" /tmp/nai-index.md

          # Individual pages
          curl -sf "$BASE_URL/getting-started.md" -o /tmp/nai-getting-started.md && \
            add_frontmatter "getting-started.md" "Getting Started with NubiferAI" "Getting Started" 10 \
              "Installation, first launch, and your first nucleation" /tmp/nai-getting-started.md

          curl -sf "$BASE_URL/providers.md" -o /tmp/nai-providers.md && \
            add_frontmatter "providers.md" "AI Providers" "Providers" 20 \
              "Setting up Claude, OpenAI, Ollama, and AWS Bedrock" /tmp/nai-providers.md

          curl -sf "$BASE_URL/gui.md" -o /tmp/nai-gui.md && \
            add_frontmatter "gui.md" "GUI Application" "GUI Application" 30 \
              "Walkthrough of the NubiferAI GTK desktop application" /tmp/nai-gui.md

          curl -sf "$BASE_URL/seeds.md" -o /tmp/nai-seeds.md && \
            add_frontmatter "seeds.md" "Seeds" "Seeds" 40 \
              "AI personas for different cloud tasks" /tmp/nai-seeds.md

          curl -sf "$BASE_URL/nubiferos-integration.md" -o /tmp/nai-nubiferos-integration.md && \
            add_frontmatter "nubiferos-integration.md" "NubiferOS Integration" "NubiferOS Integration" 50 \
              "Using NubiferAI within NubiferOS workspaces" /tmp/nai-nubiferos-integration.md

          echo "NubiferAI docs synced:"
          ls -la "$DOCS_DIR/"

      - name: Fetch NubiferAI screenshots
        run: |
          IMG_DIR="static/img/nubiferai"
          mkdir -p "$IMG_DIR"
          IMG_URL="https://raw.githubusercontent.com/nubiferos/nubiferai/trunk/docs/user-guide/screenshots"
          for img in home-page.png seeds-browser.png seed-cards-detail.png provider-dropdown.png; do
            curl -sf "$IMG_URL/$img" -o "$IMG_DIR/$img" && echo "Fetched: $img" || echo "Missing: $img"
          done
          echo "NubiferAI screenshots synced:"
          ls -la "$IMG_DIR/"

      - name: Init Hugo Modules
        run: hugo mod tidy

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Build
        run: hugo --minify --baseURL "${{ steps.pages.outputs.base_url }}/"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
